<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schoology Course Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        #sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 40;
        }

        @media (max-width: 767px) {
            .sidebar-hidden { transform: translateX(-100%); }
            .sidebar-visible { transform: translateX(0); }
        }

        .active-item {
            background-color: #f0f7ff;
            color: #2563eb;
            border-left: 4px solid #3b82f6;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        iframe { border: none; width: 100%; height: 100%; background: white; }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .markdown-copied-popup {
            animation: fadeUp 2s forwards;
        }
        @keyframes fadeUp {
            0% { opacity: 0; transform: translateY(10px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center gap-4 text-center">
            <div class="loader"></div>
            <div>
                <p id="loading-text" class="text-sm font-semibold text-slate-700">Processing...</p>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-[110] bg-slate-800 text-white px-4 py-2 rounded-full text-xs font-bold shadow-2xl markdown-copied-popup flex items-center gap-2">
        <i data-lucide="check-circle" class="w-4 h-4 text-green-400"></i>
        <span id="toast-message">Action Complete</span>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between z-50 shrink-0 shadow-sm">
        <div class="flex items-center gap-3">
            <button id="back-to-library" onclick="showLibrary()" class="hidden p-2 hover:bg-slate-100 rounded-lg text-slate-500 mr-1 transition-colors">
                <i data-lucide="layout-grid" class="w-5 h-5"></i>
            </button>
            <div class="bg-blue-600 p-2 rounded-lg shadow-sm">
                <i data-lucide="package" class="text-white w-5 h-5"></i>
            </div>
            <h1 class="text-sm font-bold text-slate-800 hidden sm:block">Schoology Course Viewer</h1>
        </div>
        
        <div class="flex items-center gap-2">
            <button id="mobile-toggle" onclick="toggleMobileView()" class="md:hidden hidden flex items-center gap-2 bg-blue-50 text-blue-600 px-3 py-2 rounded-xl text-xs font-bold border border-blue-100">
                <i data-lucide="menu" class="w-4 h-4" id="toggle-icon"></i>
                <span id="toggle-text">Menu</span>
            </button>

            <label for="file-upload" class="cursor-pointer bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg active:scale-95 transition-transform">
                <i data-lucide="plus" class="w-4 h-4"></i>
                Open File
            </label>
            <input id="file-upload" type="file" accept=".imscc,.zip" class="hidden" onchange="handleFileSelect(event)">
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        <!-- Landing State / Dropzone -->
        <div id="dropzone" class="absolute inset-0 z-[45] bg-slate-50 flex flex-col items-center justify-center p-6 text-center">
            <div class="max-w-xs w-full">
                <div class="mb-6 bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                    <i data-lucide="upload-cloud" class="w-12 h-12 text-blue-500 mx-auto mb-4"></i>
                    <h2 class="text-lg font-bold text-slate-800 mb-2">Schoology Course Viewer</h2>
                    <p class="text-slate-500 text-xs leading-relaxed text-balance">View Schoology or Canvas exports. All media is relinked locally for full preview support.</p>
                </div>
            </div>
        </div>

        <!-- Library View (Collection Picker) -->
        <div id="library-view" class="hidden absolute inset-0 z-[44] bg-slate-50 overflow-y-auto p-6">
            <div class="max-w-5xl mx-auto">
                <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-8">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Resource Library</h2>
                        <p class="text-sm text-slate-500">Select a resource collection.</p>
                    </div>
                </div>
                <div id="library-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
        </div>

        <!-- Main Workspace -->
        <div id="app-content" class="hidden flex w-full h-full relative">
            <!-- Sidebar Explorer -->
            <aside id="sidebar" class="sidebar-visible absolute inset-0 md:relative md:translate-x-0 w-full md:w-80 border-r border-slate-200 bg-white flex flex-col">
                <div class="p-4 border-b border-slate-100 flex flex-col gap-1 bg-slate-50/50">
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Navigation</span>
                        <span id="item-count" class="text-[10px] font-bold text-blue-500"></span>
                    </div>
                    <h3 id="current-root-title" class="text-xs font-bold text-slate-800 truncate">Collection Name</h3>
                </div>
                <div id="tree-container" class="flex-1 overflow-y-auto custom-scrollbar p-2 pb-24"></div>
            </aside>

            <!-- Content Viewer -->
            <section id="viewer" class="flex-1 flex flex-col bg-slate-100 w-full overflow-hidden">
                <!-- Viewer Header -->
                <div class="h-14 bg-white border-b border-slate-200 px-4 flex items-center justify-between shrink-0">
                    <div class="flex flex-col min-w-0 mr-4">
                        <p id="active-title" class="text-[11px] font-bold text-slate-800 truncate leading-tight">No file selected</p>
                        <p id="active-type" class="text-[9px] text-slate-400 uppercase tracking-tighter">Resource</p>
                    </div>
                    
                    <div class="flex items-center gap-2 shrink-0">
                        <button id="open-new-window-btn" onclick="openInNewWindow()" class="hidden flex items-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-600 border border-blue-100 rounded-lg hover:bg-blue-100 transition-colors text-[10px] font-bold">
                            <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
                            <span class="hidden sm:inline">Open in New Window</span>
                        </button>
                        <button id="download-file-btn" onclick="downloadActiveResource()" class="hidden flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-[10px] font-bold">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i>
                            <span class="hidden sm:inline">Download</span>
                        </button>
                    </div>
                </div>
                
                <!-- Main Preview Area -->
                <div class="flex-1 relative flex flex-col overflow-hidden">
                    <div id="preview-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 p-8 text-center bg-slate-50 z-0">
                        <i data-lucide="file-search" class="w-12 h-12 opacity-10 mb-4"></i>
                        <p id="placeholder-text" class="text-sm">Select a resource to preview</p>
                    </div>
                    
                    <iframe id="preview-iframe" class="hidden flex-1 z-10" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
                    
                    <!-- Attachments Footer (Always Visible if content has attachments) -->
                    <div id="attachments-footer" class="hidden bg-white border-t border-slate-200 p-4 shrink-0 z-20">
                        <div class="flex items-center gap-2 mb-2">
                            <i data-lucide="paperclip" class="w-4 h-4 text-slate-400"></i>
                            <span class="text-xs font-bold text-slate-700">Attachments</span>
                        </div>
                        <div id="attachment-list" class="flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        let currentZip = null;
        let resources = {};
        let activeBlob = null;
        let assetBlobs = []; 
        let organizations = []; 
        let currentSelection = { ref: null, title: null, href: null, type: null };

        window.onload = () => lucide.createIcons();

        function toggleMobileView() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('toggle-icon');
            const text = document.getElementById('toggle-text');
            if (sidebar.classList.contains('sidebar-hidden')) {
                sidebar.classList.remove('sidebar-hidden');
                sidebar.classList.add('sidebar-visible');
                text.innerText = "Close";
                icon.setAttribute('data-lucide', 'x');
            } else {
                sidebar.classList.remove('sidebar-visible');
                sidebar.classList.add('sidebar-hidden');
                text.innerText = "Menu";
                icon.setAttribute('data-lucide', 'menu');
            }
            lucide.createIcons();
        }

        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            const loader = document.getElementById('loading-overlay');
            loader.classList.remove('hidden');
            
            try {
                currentZip = await JSZip.loadAsync(file);
                
                // Flexible manifest search
                let manifestFile = currentZip.file("imsmanifest.xml");
                if (!manifestFile) {
                    // Try to find it in root folders
                    const files = Object.keys(currentZip.files);
                    const manifestPath = files.find(f => f.endsWith('imsmanifest.xml'));
                    if (manifestPath) manifestFile = currentZip.file(manifestPath);
                }

                if (!manifestFile) throw new Error("imsmanifest.xml not found.");
                const manifestText = await manifestFile.async("string");

                const parser = new DOMParser();
                const doc = parser.parseFromString(manifestText, "text/xml");

                resources = {};
                Array.from(doc.querySelectorAll('resource')).forEach(res => {
                    const id = res.getAttribute('identifier');
                    const files = Array.from(res.querySelectorAll('file')).map(f => f.getAttribute('href'));
                    // Ensure href matches a file in the file list if possible, or use the first file if href is missing
                    let href = res.getAttribute('href');
                    if (!href && files.length > 0) href = files[0];

                    resources[id] = {
                        type: res.getAttribute('type'),
                        href: href,
                        files: files
                    };
                });

                organizations = Array.from(doc.querySelectorAll('organization')).map(org => {
                    return {
                        id: org.getAttribute('identifier'),
                        title: org.querySelector('title')?.textContent || "Unnamed Collection",
                        type: "Course",
                        items: Array.from(org.children).filter(c => c.tagName === 'item')
                    };
                });

                document.getElementById('dropzone').classList.add('hidden');
                
                if (organizations.length > 1) renderLibraryGrid();
                else if (organizations.length === 1) loadCollection(0);
                else throw new Error("No content found in manifest.");

                lucide.createIcons();
            } catch (err) { 
                alert("Error loading cartridge: " + err.message); 
                console.error(err);
            } finally { 
                loader.classList.add('hidden'); 
            }
        }

        function renderLibraryGrid() {
            const grid = document.getElementById('library-grid');
            grid.innerHTML = '';
            document.getElementById('library-view').classList.remove('hidden');
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('back-to-library').classList.add('hidden');

            organizations.forEach((org, index) => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-2xl border border-slate-200 hover:border-blue-500 cursor-pointer transition-all card-shadow hover:-translate-y-1 flex flex-col h-full";
                card.innerHTML = `
                    <div class="flex items-start gap-4 mb-4">
                        <div class="p-3 bg-blue-50 text-blue-600 rounded-xl shrink-0"><i data-lucide="graduation-cap" class="w-6 h-6"></i></div>
                        <div class="flex-1 truncate">
                            <h4 class="font-bold text-slate-800 text-sm whitespace-normal leading-tight line-clamp-2">${org.title}</h4>
                            <div class="mt-2 flex flex-wrap gap-2">
                                <span class="text-[9px] font-bold px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-600 uppercase">${org.items.length} Root Items</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-auto"><button class="w-full py-2.5 bg-slate-50 text-slate-600 text-xs font-bold rounded-xl hover:bg-blue-600 hover:text-white transition-colors">Open</button></div>
                `;
                card.onclick = () => loadCollection(index);
                grid.appendChild(card);
            });
            lucide.createIcons();
        }

        function showLibrary() { if (organizations.length > 1) renderLibraryGrid(); }

        function loadCollection(index) {
            const org = organizations[index];
            const treeContainer = document.getElementById('tree-container');
            treeContainer.innerHTML = '';
            document.getElementById('current-root-title').innerText = org.title;
            document.getElementById('library-view').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('mobile-toggle').classList.remove('hidden');
            if (organizations.length > 1) document.getElementById('back-to-library').classList.remove('hidden');
            
            buildTree(org.items, treeContainer);
            document.getElementById('item-count').innerText = `${org.items.length} Items`;
            if (window.innerWidth < 768) toggleMobileView();
            clearPreview();
            lucide.createIcons();
        }

        function buildTree(nodes, container, depth = 0) {
            Array.from(nodes).forEach(node => {
                const title = node.querySelector('title')?.textContent || "Untitled";
                const ref = node.getAttribute('identifierref');
                const children = Array.from(node.children).filter(c => c.tagName === 'item');
                
                const el = document.createElement('div');
                el.className = `flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-colors hover:bg-slate-50 mb-1`;
                el.style.marginLeft = `${depth * 12}px`;
                
                const icon = children.length > 0 ? 'folder' : getIcon(ref);
                const iconColor = children.length > 0 ? 'text-amber-400' : 'text-slate-400';
                
                el.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4 shrink-0 ${iconColor}"></i>
                               <span class="text-xs font-semibold text-slate-700 truncate">${title}</span>`;
                
                if (ref) {
                    el.onclick = async (e) => { 
                        e.stopPropagation(); 
                        const loader = document.getElementById('loading-overlay');
                        // Show generic loading if it takes time
                        const timer = setTimeout(() => loader.classList.remove('hidden'), 500);
                        try {
                            await loadResource(el, ref, title);
                        } catch (error) {
                            console.error(error);
                            alert("Failed to load resource: " + error.message);
                        } finally {
                            clearTimeout(timer);
                            loader.classList.add('hidden');
                        }
                    };
                }
                
                container.appendChild(el);
                if (children.length > 0) buildTree(children, container, depth + 1);
            });
        }

        function clearPreview() {
            const iframe = document.getElementById('preview-iframe');
            if (activeBlob) URL.revokeObjectURL(activeBlob);
            assetBlobs.forEach(url => URL.revokeObjectURL(url));
            assetBlobs = [];
            activeBlob = null;
            currentSelection = { ref: null, title: null, href: null, type: null };
            
            iframe.src = "about:blank";
            iframe.classList.add('hidden');
            document.getElementById('preview-placeholder').classList.remove('hidden');
            document.getElementById('open-new-window-btn').classList.add('hidden');
            document.getElementById('download-file-btn').classList.add('hidden');
            document.getElementById('attachments-footer').classList.add('hidden');
            document.getElementById('active-title').innerText = "No file selected";
        }

        function resolvePath(basePath, relativePath) {
            if (!relativePath) return null;
            // Absolute or data/hash links
            if (relativePath.match(/^(http|https|data|blob|mailto|#|\/):/)) return relativePath;
            
            // Normalize path separators
            const baseDir = basePath.substring(0, basePath.lastIndexOf('/'));
            const parts = baseDir.split('/').filter(p => p !== '');
            const relParts = relativePath.split('/').filter(p => p !== '');
            
            for (const part of relParts) {
                if (part === '.') continue;
                if (part === '..') {
                    if (parts.length > 0) parts.pop();
                } else {
                    parts.push(part);
                }
            }
            
            return parts.join('/');
        }

        function openInNewWindow() {
            if (activeBlob) {
                window.open(activeBlob, '_blank');
            } else if (currentSelection.href && currentSelection.type === 'link') {
                window.open(currentSelection.href, '_blank');
            }
        }

        async function downloadActiveResource() {
            if (!currentSelection.href || !currentZip) return;
            const file = currentZip.file(currentSelection.href);
            if (!file) return;
            
            const blob = await file.async("blob");
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentSelection.href.split('/').pop();
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        async function loadResource(element, ref, title) {
            document.querySelectorAll('#tree-container div').forEach(d => d.classList.remove('active-item'));
            element.classList.add('active-item');
            clearPreview();

            const res = resources[ref];
            if (!res) throw new Error("Resource definition not found.");

            currentSelection = { ref, title, href: res.href, type: res.type };
            
            const iframe = document.getElementById('preview-iframe');
            const placeholder = document.getElementById('preview-placeholder');
            const downloadBtn = document.getElementById('download-file-btn');
            const openWindowBtn = document.getElementById('open-new-window-btn');
            const attachmentsFooter = document.getElementById('attachments-footer');

            document.getElementById('active-title').innerText = title;
            document.getElementById('active-type').innerText = res.type || 'Resource';

            // Handle Attachments
            if (res.files && res.files.length > 0) {
                const attachments = res.files.filter(f => f !== res.href); // Exclude main file
                if (attachments.length > 0) {
                    attachmentsFooter.classList.remove('hidden');
                    renderAttachments(attachments);
                }
            }

            // Handler: Web Links (IMS WL)
            if (res.type && (res.type.includes('imswl') || res.type === 'webcontent' && res.href.endsWith('.xml'))) {
                try {
                    const xmlText = await currentZip.file(res.href).async("string");
                    const xmlDoc = new DOMParser().parseFromString(xmlText, "text/xml");
                    // Try standard IMS WL locations or Schoology variations
                    let url = xmlDoc.querySelector('url')?.getAttribute('href') || 
                              xmlDoc.querySelector('check_link_url')?.getAttribute('href') ||
                              xmlDoc.querySelector('iframe_url')?.getAttribute('href');
                    
                    if (!url && xmlText.includes('http')) {
                         // Fallback simple regex if XML parsing fails
                         const match = xmlText.match(/https?:\/\/[^"'\s<]+/);
                         if (match) url = match[0];
                    }

                    if (url) {
                        currentSelection.href = url;
                        currentSelection.type = 'link';
                        placeholder.innerHTML = `
                            <div class="p-8 bg-white rounded-2xl shadow-sm border border-slate-200 text-center max-w-sm mx-auto">
                                <i data-lucide="link" class="w-10 h-10 text-blue-500 mx-auto mb-4"></i>
                                <h3 class="text-sm font-bold mb-2">External Link</h3>
                                <p class="text-xs text-slate-400 mb-6 truncate max-w-xs mx-auto">${url}</p>
                                <a href="${url}" target="_blank" class="inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all">
                                    Open Website
                                    <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
                                </a>
                            </div>`;
                        placeholder.classList.remove('hidden');
                        iframe.classList.add('hidden');
                        lucide.createIcons();
                        return;
                    }
                } catch (e) { console.error("Link parse error", e); }
            }

            // Check if main file exists
            const file = currentZip.file(res.href);
            if (!file) {
                placeholder.innerHTML = `<div class="text-center p-6 text-slate-400">
                    <i data-lucide="file-x" class="w-8 h-8 mx-auto mb-2"></i>
                    <p>File not found in package.</p>
                </div>`;
                lucide.createIcons();
                return;
            }

            const ext = res.href.split('.').pop().toLowerCase();

            // Handler: PDF
            if (ext === 'pdf') {
                const blob = await file.async("blob");
                activeBlob = URL.createObjectURL(new Blob([blob], { type: 'application/pdf' }));
                
                // Hide iframe, show specific placeholder
                iframe.classList.add('hidden');
                placeholder.innerHTML = `
                    <div class="p-8 bg-white rounded-2xl shadow-sm border border-slate-200 text-center max-w-sm mx-auto">
                        <i data-lucide="file-text" class="w-10 h-10 text-red-500 mx-auto mb-4"></i>
                        <p class="text-sm font-bold mb-2">PDF Document</p>
                        <p class="text-xs text-slate-500 mb-6 leading-relaxed">This content is a PDF. Please use the buttons below or in the header to view it.</p>
                        <div class="flex flex-col gap-2">
                            <button onclick="openInNewWindow()" class="inline-flex items-center justify-center gap-2 bg-blue-600 text-white px-6 py-2.5 rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all">
                                Open in New Window
                                <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
                            </button>
                             <button onclick="downloadActiveResource()" class="inline-flex items-center justify-center gap-2 bg-white text-slate-700 border border-slate-200 px-6 py-2.5 rounded-xl font-bold text-xs shadow-sm active:scale-95 transition-all hover:bg-slate-50">
                                Download PDF
                                <i data-lucide="download" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </div>`;
                placeholder.classList.remove('hidden');
                
                openWindowBtn.classList.remove('hidden'); 
                downloadBtn.classList.remove('hidden');
                lucide.createIcons();
            }
            // Handler: HTML
            else if (['html', 'htm'].includes(ext)) {
                let html = await file.async("string");
                const doc = new DOMParser().parseFromString(html, 'text/html');
                
                // Fix Encoding: Inject meta charset if missing
                if (!doc.head.querySelector('meta[charset]')) {
                    const meta = document.createElement('meta');
                    meta.setAttribute('charset', 'UTF-8');
                    doc.head.insertBefore(meta, doc.head.firstChild);
                }
                
                // Relink Assets
                const selectors = 'img[src], video[src], audio[src], source[src], link[rel="stylesheet"], script[src], a[href]';
                const nodes = Array.from(doc.querySelectorAll(selectors));
                
                for (const node of nodes) {
                    const attr = node.tagName === 'LINK' || node.tagName === 'A' ? 'href' : 'src';
                    const val = node.getAttribute(attr);
                    
                    if (val && !val.startsWith('http') && !val.startsWith('#') && !val.startsWith('mailto:')) {
                        const solvedPath = resolvePath(res.href, val);
                        const assetFile = currentZip.file(solvedPath);
                        
                        if (assetFile) {
                            if (node.tagName === 'A') {
                                // For links to other HTML/PDFs, we can't easily blob them inside an iframe 
                                // without intercepting navigation. For now, we'll mark them to download 
                                // or if it's an image/media link, blob it.
                                // Improvement: Add a click handler to intercept internal navigation?
                                // For now, let's leave internal relative links to download behavior if clicked?
                                // Actually, standard behavior for relative links in blob iframe is broken.
                                // We can try to bind a click listener to the iframe content?
                                node.style.textDecoration = "underline";
                                node.style.color = "blue";
                            } else {
                                const assetBlob = await assetFile.async("blob");
                                let mime = assetFile.name.endsWith('css') ? 'text/css' : 
                                          assetFile.name.endsWith('js') ? 'application/javascript' : assetBlob.type;
                                const url = URL.createObjectURL(new Blob([assetBlob], { type: mime }));
                                assetBlobs.push(url);
                                node.setAttribute(attr, url);
                            }
                        }
                    }
                }
                
                activeBlob = URL.createObjectURL(new Blob([doc.documentElement.outerHTML], { type: 'text/html;charset=utf-8' }));
                iframe.src = activeBlob;
                iframe.classList.remove('hidden');
                placeholder.classList.add('hidden');
                openWindowBtn.classList.remove('hidden');
            }
            // Handler: Images
            else if (['png', 'jpg', 'jpeg', 'gif', 'svg', 'webp'].includes(ext)) {
                const blob = await file.async("blob");
                activeBlob = URL.createObjectURL(blob);
                placeholder.innerHTML = `<img src="${activeBlob}" class="max-w-full max-h-full object-contain shadow-lg rounded-lg">`;
                placeholder.classList.remove('hidden');
                iframe.classList.add('hidden');
                downloadBtn.classList.remove('hidden');
            }
            // Handler: Generic
            else {
                placeholder.innerHTML = `
                    <div class="p-8 bg-white rounded-2xl shadow-sm border border-slate-200 text-center max-w-sm mx-auto">
                        <i data-lucide="file" class="w-10 h-10 text-slate-300 mx-auto mb-4"></i>
                        <p class="text-sm font-bold mb-4">File: ${res.href.split('/').pop()}</p>
                        <button onclick="downloadActiveResource()" class="inline-flex items-center gap-2 bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-xs shadow-md active:scale-95 transition-all">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            Download File
                        </button>
                    </div>`;
                placeholder.classList.remove('hidden');
                iframe.classList.add('hidden');
            }
            
            lucide.createIcons();
            if (window.innerWidth < 768) toggleMobileView();
        }

        function renderAttachments(files) {
            const list = document.getElementById('attachment-list');
            list.innerHTML = '';
            files.forEach(path => {
                const name = path.split('/').pop();
                const item = document.createElement('div');
                item.className = "flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 hover:bg-blue-50 cursor-pointer transition-all border border-slate-200 hover:border-blue-200 group";
                item.innerHTML = `
                    <i data-lucide="file" class="w-3 h-3 text-slate-500 group-hover:text-blue-500"></i>
                    <span class="text-[10px] font-bold text-slate-600 truncate max-w-[150px]">${name}</span>
                    <i data-lucide="download" class="w-3 h-3 text-slate-300 group-hover:text-blue-500 ml-2"></i>
                `;
                item.onclick = async () => {
                    const file = currentZip.file(path);
                    if (file) {
                        const blob = await file.async("blob");
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = name;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        setTimeout(() => URL.revokeObjectURL(url), 100);
                    }
                };
                list.appendChild(item);
            });
            lucide.createIcons();
        }

        function getIcon(ref) {
            if (!ref) return 'folder';
            const t = resources[ref]?.type || '';
            if (t.includes('imswl')) return 'link';
            if (t.includes('imsdt')) return 'message-square';
            if (t.includes('webcontent')) {
                const h = resources[ref]?.href || '';
                if (h.endsWith('.pdf')) return 'file-text';
                if (h.endsWith('.jpg') || h.endsWith('.png')) return 'image';
            }
            return 'file';
        }
    </script>
</body>
</html>
