<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Common Cartridge Viewer</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .tree-item:hover {
            background-color: #f1f5f9;
        }

        .active-item {
            background-color: #e2e8f0;
            border-left: 4px solid #3b82f6;
        }

        iframe {
            background: white;
            border: none;
            width: 100%;
            height: 100%;
        }

        #dropzone.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between z-10 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i data-lucide="package" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800">IMSCC Explorer</h1>
                <p class="text-xs text-slate-500 font-medium">Common Cartridge Previewer</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <label for="file-upload" class="cursor-pointer bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                Open Cartridge
            </label>
            <input id="file-upload" type="file" accept=".imscc,.zip" class="hidden" onchange="handleFileSelect(event)">
            <button onclick="resetApp()" class="text-slate-400 hover:text-red-500 transition-colors">
                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        <!-- Empty State / Dropzone -->
        <div id="dropzone" class="absolute inset-0 z-20 bg-slate-50 flex flex-col items-center justify-center p-6 transition-all">
            <div class="max-w-md w-full border-2 border-dashed border-slate-300 rounded-2xl p-12 text-center bg-white shadow-xl">
                <div class="mb-6 inline-flex p-4 bg-blue-50 text-blue-600 rounded-full">
                    <i data-lucide="file-archive" class="w-12 h-12"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Ready to explore?</h2>
                <p class="text-slate-500 mb-8 leading-relaxed">Drag and drop your Schoology or Canvas .imscc file here, or use the button above to select one from your computer.</p>
                
                <div class="grid grid-cols-2 gap-4 text-left">
                    <div class="flex items-start gap-2 text-sm text-slate-600">
                        <i data-lucide="shield-check" class="w-4 h-4 text-green-500 mt-0.5"></i>
                        <span>100% Private - No uploads</span>
                    </div>
                    <div class="flex items-start gap-2 text-sm text-slate-600">
                        <i data-lucide="zap" class="w-4 h-4 text-yellow-500 mt-0.5"></i>
                        <span>Fast Browser Extraction</span>
                    </div>
                </div>
            </div>
            <p class="mt-8 text-slate-400 text-sm">Supported formats: .imscc (Common Cartridge), .zip</p>
        </div>

        <!-- App Layout (Hidden until file loaded) -->
        <div id="app-content" class="hidden flex w-full h-full">
            
            <!-- Sidebar -->
            <aside class="w-80 border-r border-slate-200 bg-white flex flex-col">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Course Structure</h3>
                </div>
                <div id="tree-container" class="flex-1 overflow-y-auto custom-scrollbar p-2">
                    <!-- Tree items injected here -->
                    <div class="flex items-center justify-center h-full text-slate-400 text-sm">
                        Loading contents...
                    </div>
                </div>
            </aside>

            <!-- Content Area -->
            <section class="flex-1 flex flex-col bg-slate-100">
                <!-- Viewer Header -->
                <div class="h-12 border-b border-slate-200 bg-white px-4 flex items-center justify-between">
                    <div id="active-item-title" class="text-sm font-medium text-slate-700 truncate max-w-lg italic">
                        Select an item to preview content
                    </div>
                    <div id="viewer-actions" class="hidden flex gap-2">
                        <button id="open-new-tab" class="text-xs bg-slate-100 hover:bg-slate-200 px-3 py-1 rounded border border-slate-200 flex items-center gap-1 transition-colors">
                            <i data-lucide="external-link" class="w-3 h-3"></i>
                            Open in New Tab
                        </button>
                    </div>
                </div>
                
                <!-- The Previewer -->
                <div class="flex-1 relative overflow-hidden" id="preview-frame-container">
                    <div id="preview-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 space-y-4">
                        <i data-lucide="eye" class="w-12 h-12 opacity-20"></i>
                        <p>Document preview will appear here</p>
                    </div>
                    <iframe id="preview-iframe" class="hidden" sandbox="allow-scripts allow-same-origin"></iframe>
                </div>
            </section>
        </div>
    </main>

    <!-- Error Modal -->
    <div id="error-modal" class="hidden fixed inset-0 z-50 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
            <div class="bg-red-100 text-red-600 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="alert-triangle"></i>
            </div>
            <h3 class="text-lg font-bold text-slate-800 mb-2">Could not open file</h3>
            <p id="error-message" class="text-slate-500 text-sm mb-6"></p>
            <button onclick="closeError()" class="w-full bg-slate-800 text-white py-2 rounded-lg font-medium">Try another file</button>
        </div>
    </div>

    <script>
        // --- State Management ---
        let currentZip = null;
        let manifestData = null;
        let activeBlobUrl = null;
        let resourcesMap = {};

        // --- Initialization ---
        window.onload = () => {
            lucide.createIcons();
            setupDragAndDrop();
        };

        function setupDragAndDrop() {
            const dropzone = document.getElementById('dropzone');
            
            window.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('drag-over');
            });

            window.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');
            });

            window.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('drag-over');
                const file = e.dataTransfer.files[0];
                if (file) processFile(file);
            });
        }

        // --- File Handling ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) processFile(file);
        }

        async function processFile(file) {
            try {
                showLoading(true);
                const zip = await JSZip.loadAsync(file);
                currentZip = zip;

                // 1. Find manifest
                const manifestFile = zip.file("imsmanifest.xml");
                if (!manifestFile) throw new Error("This doesn't look like a valid Common Cartridge. 'imsmanifest.xml' missing.");

                const xmlText = await manifestFile.async("string");
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");

                // 2. Map Resources
                resourcesMap = {};
                const resources = xmlDoc.getElementsByTagName("resource");
                for (let res of resources) {
                    const id = res.getAttribute("identifier");
                    const type = res.getAttribute("type");
                    const href = res.getAttribute("href");
                    
                    // Collect dependencies (files)
                    const files = [];
                    const fileNodes = res.getElementsByTagName("file");
                    for (let fn of fileNodes) {
                        files.push(fn.getAttribute("href"));
                    }

                    resourcesMap[id] = { type, href, files };
                }

                // 3. Build UI Tree from Organizations
                const orgs = xmlDoc.getElementsByTagName("organization");
                if (orgs.length === 0) throw new Error("No organization structure found in manifest.");
                
                const treeContainer = document.getElementById('tree-container');
                treeContainer.innerHTML = '';
                
                const items = orgs[0].getElementsByTagName("item");
                buildTree(items, treeContainer);

                // UI Transitions
                document.getElementById('dropzone').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                lucide.createIcons();

            } catch (err) {
                showError(err.message);
            } finally {
                showLoading(false);
            }
        }

        function buildTree(itemNodes, container, depth = 0) {
            // Note: Common Cartridges can be flat or nested. 
            // We process them based on parent-child relationships in XML.
            // For simplicity in this demo, we iterate items and check for identifiers.
            
            for (let node of itemNodes) {
                // Only process top level or direct children of the container's parent node
                if (node.parentElement.tagName !== 'organization' && node.parentElement.tagName !== 'item') continue;
                if (node.parentElement === container._node) continue; 

                const title = node.getElementsByTagName("title")[0]?.textContent || "Untitled Item";
                const identifierRef = node.getAttribute("identifierref");
                const hasChildren = node.getElementsByTagName("item").length > 0;

                const itemDiv = document.createElement('div');
                itemDiv.className = `tree-item transition-all cursor-pointer rounded px-2 py-1.5 mb-0.5 flex items-center gap-2 group`;
                itemDiv.style.paddingLeft = `${depth * 16 + 8}px`;

                const iconName = hasChildren ? "folder" : getIconForType(identifierRef);
                
                itemDiv.innerHTML = `
                    <i data-lucide="${iconName}" class="w-4 h-4 ${hasChildren ? 'text-amber-500' : 'text-slate-500'}"></i>
                    <span class="text-sm text-slate-700 truncate flex-1">${title}</span>
                `;

                if (identifierRef) {
                    itemDiv.onclick = (e) => {
                        e.stopPropagation();
                        selectItem(itemDiv, identifierRef, title);
                    };
                } else if (hasChildren) {
                    // It's a folder toggle
                    itemDiv.onclick = (e) => {
                        e.stopPropagation();
                        const nextSiblings = itemDiv.nextElementSibling;
                        // Basic toggle logic could go here
                    };
                }

                container.appendChild(itemDiv);

                // Recursively handle nested items
                if (hasChildren) {
                    const subItems = Array.from(node.children).filter(c => c.tagName === 'item');
                    buildTree(subItems, container, depth + 1);
                }
            }
            lucide.createIcons();
        }

        function getIconForType(id) {
            if (!id || !resourcesMap[id]) return "file";
            const type = resourcesMap[id].type;
            if (type.includes('webcontent')) return "file-text";
            if (type.includes('imsdt')) return "message-square";
            if (type.includes('imswl')) return "link";
            if (type.includes('associatedcontent')) return "layers";
            return "file";
        }

        async function selectItem(element, id, title) {
            // Update UI
            document.querySelectorAll('.tree-item').forEach(el => el.classList.remove('active-item'));
            element.classList.add('active-item');
            document.getElementById('active-item-title').innerText = title;
            document.getElementById('viewer-actions').classList.remove('hidden');

            const resource = resourcesMap[id];
            if (!resource) return;

            const iframe = document.getElementById('preview-iframe');
            const placeholder = document.getElementById('preview-placeholder');
            
            showLoading(true);

            try {
                // Cleanup old blob
                if (activeBlobUrl) URL.revokeObjectURL(activeBlobUrl);

                let contentUrl = "";
                let mimeType = "text/html";

                if (resource.type.includes('imswl')) {
                    // It's a web link XML
                    const linkFile = currentZip.file(resource.href);
                    const xml = await linkFile.async("string");
                    const url = new DOMParser().parseFromString(xml, "text/xml").getElementsByTagName("url")[0]?.getAttribute("href");
                    
                    iframe.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                    placeholder.innerHTML = `
                        <div class="text-center p-8 bg-white rounded-xl shadow-sm border border-slate-200">
                            <i data-lucide="link" class="w-12 h-12 text-blue-500 mx-auto mb-4"></i>
                            <h4 class="text-lg font-bold text-slate-800 mb-2">External Link</h4>
                            <p class="text-slate-500 mb-6 max-w-xs">${url}</p>
                            <a href="${url}" target="_blank" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-medium inline-block">Open Website</a>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                // Handle Standard Files (HTML, PDF, Images)
                const file = currentZip.file(resource.href);
                if (!file) throw new Error("Internal file pointer is broken.");

                const extension = resource.href.split('.').pop().toLowerCase();
                if (extension === 'pdf') mimeType = "application/pdf";
                else if (['png', 'jpg', 'jpeg', 'gif'].includes(extension)) mimeType = `image/${extension}`;

                const blob = await file.async("blob");
                activeBlobUrl = URL.createObjectURL(new Blob([blob], { type: mimeType }));
                
                iframe.src = activeBlobUrl;
                iframe.classList.remove('hidden');
                placeholder.classList.add('hidden');

                document.getElementById('open-new-tab').onclick = () => window.open(activeBlobUrl, '_blank');

            } catch (err) {
                console.error(err);
                placeholder.innerHTML = `<p class="text-red-500">Error loading resource: ${err.message}</p>`;
            } finally {
                showLoading(false);
            }
        }

        // --- Helpers ---
        function showLoading(isLoading) {
            // Simple visual feedback
            document.body.style.cursor = isLoading ? 'wait' : 'default';
        }

        function showError(msg) {
            document.getElementById('error-message').innerText = msg;
            document.getElementById('error-modal').classList.remove('hidden');
        }

        function closeError() {
            document.getElementById('error-modal').classList.add('hidden');
        }

        function resetApp() {
            if (activeBlobUrl) URL.revokeObjectURL(activeBlobUrl);
            location.reload();
        }

    </script>
</body>
</html>

