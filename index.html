<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IMSCC Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Mobile Overlay Logic */
        #sidebar {
            transition: transform 0.3s ease-in-out;
            z-index: 40;
        }

        @media (max-width: 767px) {
            .sidebar-hidden { transform: translateX(-100%); }
            .sidebar-visible { transform: translateX(0); }
        }

        .active-item {
            background-color: #f0f7ff;
            color: #2563eb;
            border-left: 4px solid #3b82f6;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        iframe { border: none; width: 100%; height: 100%; background: white; }

        /* Loader Animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-[100] bg-slate-900/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center gap-4">
            <div class="loader"></div>
            <p class="text-sm font-semibold text-slate-700">Unpacking Cartridge...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between z-50 shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg shadow-sm">
                <i data-lucide="package" class="text-white w-5 h-5"></i>
            </div>
            <h1 class="text-sm font-bold text-slate-800 hidden xs:block">IMSCC Explorer</h1>
        </div>
        
        <div class="flex items-center gap-2">
            <button id="mobile-toggle" onclick="toggleMobileView()" class="md:hidden hidden flex items-center gap-2 bg-blue-50 text-blue-600 px-3 py-2 rounded-xl text-xs font-bold border border-blue-100">
                <i data-lucide="menu" class="w-4 h-4" id="toggle-icon"></i>
                <span id="toggle-text">Menu</span>
            </button>

            <label for="file-upload" class="cursor-pointer bg-slate-900 text-white px-4 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-lg active:scale-95 transition-transform">
                <i data-lucide="plus" class="w-4 h-4"></i>
                Open
            </label>
            <input id="file-upload" type="file" accept=".imscc,.zip" class="hidden" onchange="handleFileSelect(event)">
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        <!-- Landing State -->
        <div id="dropzone" class="absolute inset-0 z-[45] bg-slate-50 flex flex-col items-center justify-center p-6 text-center">
            <div class="max-w-xs w-full">
                <div class="mb-6 bg-white p-8 rounded-3xl shadow-sm border border-slate-100">
                    <i data-lucide="upload-cloud" class="w-12 h-12 text-blue-500 mx-auto mb-4"></i>
                    <h2 class="text-lg font-bold text-slate-800 mb-2">Upload Cartridge</h2>
                    <p class="text-slate-500 text-xs leading-relaxed">Select a .imscc file exported from Schoology or Canvas to preview content.</p>
                </div>
            </div>
        </div>

        <!-- App Workspace -->
        <div id="app-content" class="hidden flex w-full h-full relative">
            
            <!-- Sidebar Explorer -->
            <aside id="sidebar" class="sidebar-visible absolute inset-0 md:relative md:translate-x-0 w-full md:w-80 border-r border-slate-200 bg-white flex flex-col">
                <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Navigation</span>
                    <span id="item-count" class="text-[10px] font-bold text-blue-500"></span>
                </div>
                <div id="tree-container" class="flex-1 overflow-y-auto custom-scrollbar p-2 pb-24">
                    <!-- Dynamic Items -->
                </div>
            </aside>

            <!-- Content Viewer -->
            <section id="viewer" class="flex-1 flex flex-col bg-slate-100 w-full overflow-hidden">
                <div class="h-10 bg-white border-b border-slate-200 px-4 flex items-center shrink-0">
                    <p id="active-title" class="text-[11px] font-medium text-slate-500 truncate italic">No file selected</p>
                </div>
                <div class="flex-1 relative">
                    <div id="preview-placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 p-8 text-center">
                        <i data-lucide="book-open" class="w-12 h-12 opacity-10 mb-4"></i>
                        <p class="text-sm">Select a resource to preview</p>
                    </div>
                    <iframe id="preview-iframe" class="hidden" sandbox="allow-scripts allow-same-origin"></iframe>
                </div>
            </section>
        </div>
    </main>

    <script>
        let currentZip = null;
        let resources = {};
        let activeBlob = null;
        let isMenuOpen = true;

        window.onload = () => lucide.createIcons();

        function toggleMobileView() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('toggle-icon');
            const text = document.getElementById('toggle-text');

            if (sidebar.classList.contains('sidebar-hidden')) {
                sidebar.classList.remove('sidebar-hidden');
                sidebar.classList.add('sidebar-visible');
                text.innerText = "Close";
                icon.setAttribute('data-lucide', 'x');
            } else {
                sidebar.classList.remove('sidebar-visible');
                sidebar.classList.add('sidebar-hidden');
                text.innerText = "Menu";
                icon.setAttribute('data-lucide', 'menu');
            }
            lucide.createIcons();
        }

        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            const loader = document.getElementById('loading-overlay');
            loader.classList.remove('hidden');

            try {
                currentZip = await JSZip.loadAsync(file);
                const manifest = await currentZip.file("imsmanifest.xml")?.async("string");
                if (!manifest) throw new Error("Manifest not found.");

                const parser = new DOMParser();
                const doc = parser.parseFromString(manifest, "text/xml");

                // Parse Resources
                resources = {};
                Array.from(doc.querySelectorAll('resource')).forEach(res => {
                    resources[res.getAttribute('identifier')] = {
                        type: res.getAttribute('type'),
                        href: res.getAttribute('href')
                    };
                });

                // Build Tree
                const treeContainer = document.getElementById('tree-container');
                treeContainer.innerHTML = '';
                const items = doc.querySelector('organization')?.querySelectorAll('item') || [];
                
                buildTree(items, treeContainer);
                document.getElementById('item-count').innerText = `${items.length} Items`;

                // Switch UI
                document.getElementById('dropzone').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                document.getElementById('mobile-toggle').classList.remove('hidden');
                
                // Force mobile view to show the tree initially
                if (window.innerWidth < 768) {
                    const sidebar = document.getElementById('sidebar');
                    sidebar.classList.remove('sidebar-hidden');
                    sidebar.classList.add('sidebar-visible');
                }

                lucide.createIcons();
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        function buildTree(nodes, container, depth = 0) {
            Array.from(nodes).forEach(node => {
                if (node.parentElement.tagName !== 'organization' && node.parentElement.tagName !== 'item') return;

                const title = node.querySelector('title')?.textContent || "Untitled";
                const ref = node.getAttribute('identifierref');
                const children = Array.from(node.children).filter(c => c.tagName === 'item');

                const el = document.createElement('div');
                el.className = `flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-colors hover:bg-slate-50 mb-1`;
                el.style.marginLeft = `${depth * 12}px`;

                const icon = children.length > 0 ? 'folder' : getIcon(ref);
                el.innerHTML = `
                    <i data-lucide="${icon}" class="w-4 h-4 shrink-0 ${children.length > 0 ? 'text-amber-400' : 'text-slate-400'}"></i>
                    <span class="text-xs font-semibold text-slate-700 truncate">${title}</span>
                `;

                if (ref) {
                    el.onclick = () => loadResource(el, ref, title);
                }
                
                container.appendChild(el);
                if (children.length > 0) buildTree(children, container, depth + 1);
            });
        }

        async function loadResource(element, ref, title) {
            document.querySelectorAll('#tree-container > div').forEach(d => d.classList.remove('active-item'));
            element.classList.add('active-item');

            const res = resources[ref];
            const iframe = document.getElementById('preview-iframe');
            const placeholder = document.getElementById('preview-placeholder');

            if (activeBlob) URL.revokeObjectURL(activeBlob);

            try {
                if (res.type.includes('imswl')) {
                    const xml = await currentZip.file(res.href).async("string");
                    const url = new DOMParser().parseFromString(xml, "text/xml").querySelector('url')?.getAttribute('href');
                    placeholder.innerHTML = `<div class="p-6 bg-white rounded-2xl shadow-sm border border-slate-200 text-center">
                        <p class="text-sm font-bold mb-4">Web Link</p>
                        <a href="${url}" target="_blank" class="text-blue-600 underline text-xs break-all">${url}</a>
                    </div>`;
                    iframe.classList.add('hidden');
                    placeholder.classList.remove('hidden');
                } else {
                    const file = currentZip.file(res.href);
                    const blob = await file.async("blob");
                    const mime = res.href.endsWith('.pdf') ? 'application/pdf' : 'text/html';
                    activeBlob = URL.createObjectURL(new Blob([blob], { type: mime }));
                    iframe.src = activeBlob;
                    iframe.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                }

                document.getElementById('active-title').innerText = title;
                
                // On Mobile: Hide menu after selection
                if (window.innerWidth < 768) toggleMobileView();

            } catch (e) {
                placeholder.innerHTML = `<p class="text-red-500">Error loading file</p>`;
            }
            lucide.createIcons();
        }

        function getIcon(ref) {
            if (!ref) return 'folder';
            const type = resources[ref]?.type || '';
            if (type.includes('imswl')) return 'link';
            if (type.includes('imsdt')) return 'message-square';
            return 'file-text';
        }
    </script>
</body>
</html>

